User Reassignment Process - Developer Summary 

This document outlines the required system behavior when a user is terminated or replaced, necessitating the reassignment of their associated data and responsibilities. The process involves identifying objects linked to the "Previous User" and reassigning them, with specific granular handling for opportunities. 

---

## Implementation Status Snapshot (as of 2025-11-24)

### High-level view

- Overall: **Not yet implemented end-to-end.** The app currently supports **account-level bulk reassignment** (accounts and some related opportunities/revenue schedules) plus some **commission engine scaffolding**, but there is **no full “User Reassignment” flow** that starts from a terminated user and walks through all affected entities, and **no passthrough-rate automation** yet.

### Feature-by-feature status

1. **Reassignment Trigger & General Object Reassignment**
   - **Status:** Partially implemented (account-centric only).
   - **Completed / in place:**
     - `AccountReassignmentModal` on the **Accounts List** (`app/(dashboard)/accounts/page.tsx`) lets managers bulk reassign selected accounts, with:
       - Manager-only guard via `accounts.reassign` + `accounts.bulk` permissions.
       - A multi-step flow (selection → impact preview → confirm).
     - `/api/accounts/reassignment-preview` calculates per-account impact: upcoming opportunities, revenue schedules, active contacts, open activities, active groups, and open tasks.
     - `/api/accounts/bulk-reassign`:
       - Updates `Account.ownerId` and `AccountAssignment` for the new owner.
       - Updates **future-dated opportunities** on those accounts to the new `ownerId` (or `null` when assigning to “house” in the future).
       - Calls `calculateCommissionImpact` to summarize affected revenue and expected commissions.
       - Writes audit rows and sends notifications for completed reassignments.
   - **Missing relative to this spec:**
     - No **admin-level “User Reassignment” wizard** that starts from a **Previous User** and automatically finds:
       - All Accounts, Contacts, Groups, Reports, Products, Activities, and Tickets where that user is owner/creator.
     - No linkage between **user termination/removal** and reassignment:
       - Effective date is chosen manually in the modal; it is **not defaulted/enforced** to the **1st of the month of removal**.
       - There is no “previous user” → “new house rep” selection at the **user level**; everything is account-based.
     - Non-opportunity entities from this section (**Contacts, Groups, Reports, Products**) are **not** touched by `/api/accounts/bulk-reassign`; they would still need their own bulk flows.
     - Open Activities and Tickets are **not** automatically reassigned as part of `/api/accounts/bulk-reassign`; only separate per-module bulk owner tools exist.
   - **Gaps / inconsistencies:**
     - The current flow is **account-centric** (“select accounts, then choose new owner”), while this document assumes a **user-centric** trigger (“select Previous User, then walk all their entities”).
     - Commission impact preview works at the **total expectedCommission** level and **does not understand House vs House Rep vs Subagent splits** yet.
   - **Suggested next steps:**
     - Add a dedicated **`/admin/user-reassignment`** wizard that:
       - Accepts a Previous User and derives a default effective date (1st of the month of a termination/disabled date once that attribute exists on `User`).
       - Uses shared queries to pull all owned/created entities (Accounts, Contacts, Groups, Tickets, etc.).
       - Reuses existing bulk APIs (`/api/accounts/bulk-reassign` and future equivalents for contacts, groups, tickets) under one guided flow.
     - Extend bulk operations so Contacts, Groups, Reports, Products, and Tickets can be included in the same reassignment batch.

2. **Opportunity Handling**
   - **Status:** Not implemented (engine scaffolding only).
   - **Completed / in place:**
     - The data model already stores basic commission context:
       - `Opportunity` includes `houseRepPercent`, `houseSplitPercent`, and `subagentPercent`.
       - `OpportunityRole` links contacts to opportunities with role names (foundation for House Rep/Subagent).
     - Core engine utilities exist but are **not wired** to UI/APIs yet:
       - `lib/commission-engine.ts` implements `computeNewSplits` and `applyReassignment` for Type A/B/C style logic.
       - `lib/commission-proration.ts` implements `prorateSchedules` to adjust revenue schedules around a cutoff date.
       - `jobs/reassignment-runner.ts` orchestrates batch-level commission changes across opportunities.
   - **Missing relative to this spec:**
     - No **Opportunity detail page** at `app/(dashboard)/opportunities/[opportunityId]/page.tsx`; the folder exists but is empty.
     - No **“Manage Commissions”** UI/modal on opportunities to:
       - Choose Type A (**House absorbs**), Type B (**Direct transfer**), or Type C (**Custom**) when a rep is removed.
       - Preview before/after commission splits and revenue schedule deltas.
     - No implementation of:
       - “Commissioned/Closed” opportunity behavior where **future** revenue schedules reroute the departing rep’s share (to House or to a new owner) while preserving historical payouts.
       - “In-flight” opportunity behavior with per-opportunity **Option A (New House Rep)** vs **Option B (House Account)** decisions.
     - No `"No House Rep"` contact record and **no field on Revenue Schedules** to store a dummy house_rep contact; the system currently models **dummy users** (via `lib/special-users.ts`) instead of a dummy contact.
   - **Gaps / inconsistencies:**
     - The engine code assumes schema fields and tables like:
       - `currentCommissionJson`, `commissionStatus` on `Opportunity`.
       - `CommissionChange` and `ReassignmentBatch` models.
       - `prorationApplied` on `RevenueSchedule`.
       - These **do not exist** in `prisma/schema.prisma` yet, so `commission-engine`, `commission-proration`, and `reassignment-runner` would fail if invoked as-is.
   - **Suggested next steps:**
     - Align the Prisma schema with the **Commission Reassignment Implementation Plan** (add `CommissionChange`, `ReassignmentBatch`, `currentCommissionJson`, `commissionStatus`, `prorationApplied`, etc.).
     - Implement Level 1 / Level 3 APIs:
       - `/api/opportunities/[id]/commissions/preview` and `/api/opportunities/[id]/commissions/reassign`.
       - `/api/reassignment-batches/*` for global rep-level operations.
     - Build the **Opportunity detail + Commission Management modal** to expose Option A/B/C per this document.
     - Seed and consistently use a **“No House Rep” system contact** (or reconcile the contact-vs-user dummy approach) for cases where the House receives commissions but no individual rep does.

3. **Activity and Ticket Handling**
   - **Status:** Not implemented as an automatic part of user reassignment.
   - **Completed / in place:**
     - Activities and Tickets have full CRUD + list UIs, including:
       - Bulk owner/status modals per module (`ActivityBulkOwnerModal`, `ActivityBulkStatusModal`, ticket equivalents).
       - Service layer helpers (`lib/activity-service.ts`) and ticket APIs that understand open vs closed statuses.
   - **Missing relative to this spec:**
     - No **orchestrated reassignment** of Activities and Tickets when a user is terminated or replaced:
       - `/api/accounts/bulk-reassign` does **not** change `assigneeId` or `creatorId` on Activities/Tickets.
       - There is no single action that reassigns **all open/pending Activities/Tickets** for a Previous User to a New House Rep while leaving closed/inactive items untouched.
   - **Suggested next steps:**
     - Add a dedicated service (e.g. `reassignUserWorkItems(fromUserId, toUserId, effectiveDate)`) that:
       - Finds all Activities/Tickets where `assigneeId = fromUserId` and status is open/pending, and reassigns them to `toUserId`.
       - Preserves history by logging appropriate audit entries and leaving closed items unchanged.
     - Integrate that service into the future `/admin/user-reassignment` wizard so Activities/Tickets are handled alongside Accounts and Opportunities.

4. **User Interface Considerations (House Rep Replacement Form & module displays)**
   - **Status:** Partially implemented (general admin & account tools exist; House Rep–specific UI does not).
   - **Completed / in place:**
     - An **Admin Panel** exists at `app/(dashboard)/admin` with User Management, Role Management, and System Settings.
     - The Accounts list page:
       - Uses the shared `ListHeader` + `DynamicTable` infrastructure.
       - Exposes **Reassign** as a bulk action, opening `AccountReassignmentModal`.
       - Shows an `AuditHistoryTab` on Account detail views to review changes (including reassignments logged via `reassignment-audit.ts`).
   - **Missing relative to this spec:**
     - No dedicated **“House Rep Replacement” form** in the Admin section that:
       - Starts from **Previous User + Effective Date (1st of month)**.
       - Lists **in-flight opportunities** and lets the admin choose Option A (New Rep) vs Option B (House Account) per opportunity.
     - No module-level UI that explicitly surfaces “House Rep has been replaced; here is the prior vs current House Rep” on Accounts, Opportunities, or Contacts; today this is only inferable via generic audit history.
   - **Suggested next steps:**
     - Add an **Admin → User Reassignment** entry that launches the full wizard for terminated/replaced reps, reusing:
       - Account selection + impact preview from `AccountReassignmentModal`.
       - New opportunity-level commission tools from Section 2 once implemented.
     - Add lightweight, read-only “House Rep / Replacement History” panels to Account, Opportunity, and Contact detail pages, backed by `CommissionChange` / audit logs once those tables exist.

5. **Changing the global passthrough rate % for a single vendor’s products from a specified date**
   - **Status:** Not implemented (concept only).
   - **Completed / in place:**
     - Data model supports commission-related fields on Products, Opportunity Line Items, and Revenue Schedules (`expectedCommission`, `commissionPercent`, `expectedCommissionRate` in field specs).
     - Revenue Schedule UIs now support **inline editing and multi-select “Apply to selected”** workflows:
       - Production page at `app/(dashboard)/revenue-schedules/page.tsx`.
       - A dedicated **Fill-Down Test** prototype at `/revenue-schedules/fill-down-test` used to validate bulk edit UX for **Expected Commission Rate %** and related fields.
   - **Missing relative to this spec:**
     - No workflow that:
       - Starts from a **single vendor + product** and surfaces all related revenue schedules, or
       - Allows selecting multiple schedules by product, picking an effective date, and applying a new **Expected Commission Rate %** across them.
     - No logic that derives **Agency Expected Commission Rate** from raw distributor-level commission data (“raw x passthrough rate %”) or automates back-calculation from reports.
     - No toggle between:
       - “All **existing and billing** revenue schedules will be paid at the new rate” vs
       - “Only **new revenue schedules sold after a date** will be paid at that new rate.”
   - **Suggested next steps:**
     - Treat this as a **separate change order / phase**, as already flagged in other planning docs to avoid scope creep.
     - When prioritized:
       - Reuse the revenue schedule table + bulk edit UX to filter by **vendor + product**, then apply new `Expected Commission Rate %` for schedules whose `scheduleDate >= effectiveDate`.
       - Optionally add a small helper that computes the implied passthrough rate from distributor reports and persists it on Product for future deals.

6. **Products Module – future global passthrough rate option**
   - **Status:** Not implemented (explicitly future-scope).
   - **Completed / in place:**
     - Products, Opportunities, and Revenue Schedules share a consistent **Revenue Type** and commission field model (`Revenue_Type_fields.md`, `lib/revenue-types.ts`).
     - Table and modal infrastructure is already in place for bulk operations and inline editing on Products and Revenue Schedules.
   - **Missing relative to this spec:**
     - No Products-module UI to:
       - Select a **vendor**, then multiple products, and change a **global passthrough rate** that propagates to existing revenue schedules from a given date forward.
     - No reporting or reconciliation logic yet that validates or backfills historical passthrough changes from external statements.
   - **Suggested next steps:**
     - Keep this explicitly in the **“Later / Future”** bucket until the core user reassignment + commission engine work is complete.
     - When implemented, align it with the revenue-schedule passthrough workflow so vendor-level changes and schedule-level adjustments share a single calculation model and audit trail.

1. Reassignment Trigger & General Object Reassignment 

Trigger: An administrative action initiates the user reassignment process. This will be facilitated by a dedicated form within the admin section. 

Reassignment Date: The effective date for all reassignments and commission changes will be the 1st of the month of the user's removal. 

Identification: The system must provide functionality to filter and display all Accounts, Contacts, Groups, Reports, and Products (and any other relevant entities) where the "Previous User" is either the assigned_user or the creator. 

Action: A "Reassign to New User" button or similar mechanism will be available. 

Selection: The administrator will select a "New House Rep" (the designated successor). 

Update Logic (Non-Opportunities): All identified non-opportunity objects (Accounts, Contacts, Groups, Reports, and Products) will have their assigned_user or creator field updated to the selected "New House Rep". Open Activities and Tickets are also reassigned here (see Section 3). 

2. Opportunity Handling 

This section details the nuanced handling of Opportunities and their associated Revenue Schedules based on their status at the time of reassignment. 

Definition: A "House Rep" refers to an internal company representative. 

Commission Share Structure: The system manages commission shares (up to 100%) split between the "House," "House Rep," and "Subagent." 

Impact of House Rep/Subagent Removal: If a "House Rep" or "Subagent" is removed, their commission shares for future periods will cease on the 1st of the month of the change. Their respective percentages will be added to the "House's" percentage of the take. For example, if a 50/50 split between House and House Rep exists, and the House Rep is removed on October 5, 2025, then starting October 1, 2025, the House will receive 100% of all commissions going forward for affected opportunities. 

Opportunities with Associated Revenue Schedules (Commissioned/Closed): 

Condition: For opportunities that were already commissioned (closed-won) before the user's reassignment date (1st of the month of removal). 

Future Revenue Schedules Impact: If a house rep is fired/quits/reassigned, and the house takes over management, any future revenue schedules associated with these opportunities will have the "Previous User's" commission portion (100% of their share, minus any sub-agent splits) converted to the "House's Portion”, unless the owner allows the new owner to earn commissions on that deal from the change date forward.  This is based upon the admin selection during the assignment process.   If a Subagent exists, the sub-agent splits will be preserved and managed independently, continuing to be paid to the sub-agents. 

Historical Data: Previously reconciled revenue schedules (those processed and paid out prior to the reassignment date) must remain associated with the "Previous User's" name and commission history. 

Opportunities "In-Flight" (Pipeline/Not Closed) - Granular Reassignment: 

Condition: For opportunities currently in the pipeline (not yet closed/commissioned) at the time of reassignment. The administrative form must allow the admin to review all in-flight opportunities owned by the "Previous User" and choose a reassignment path for each opportunity individually. 

Option A: Reassign to New House Rep: The administrator elects to reassign the entire opportunity to a "New House Rep." This new rep becomes the House Rep of Record for this opportunity and is eligible for their full commission split upon closure. 

Option B: Convert to House Account: The administrator elects to convert the opportunity into a "House Account." In this scenario, the "Previous User's" commission portion (100% of their share, minus any sub-agent splits) will be converted to the "House's Portion" upon closure. This commission conversion is effective the 1st of the month of removal. The "New House Rep" will manage the account/contact, but this specific in-flight deal pays commission to the house. 

"No House Rep" Contact: 

Creation: A new Contact record named "No House Rep" must be created in the system. This contact should be associated with the parent account of the agency utilizing the software. 

Usage: For any future revenue schedules where the commission is converted to the "House's Portion" (as described in Option B above), the house_rep field for these specific revenue schedules should be explicitly designated as this "No House Rep" contact. This "No House Rep" contact will have a 0% share of commissions and serves as a dummy contact for reassigning in-flight records where no individual rep is assigned commission. 

3. Activity and Ticket Handling 

Closed or Inactive Items: 

Activities and Tickets created by the "Previous User" that are already closed or marked as inactive will remain associated with the "Previous User." Their creator or signature field will not be altered. 

Open or Pending Items: 

Activities and Tickets created by the "Previous User" that are currently open or pending will be reassigned to the "New House Rep" as part of the general reassignment. This ensures continuity for ongoing tasks. 

4. User Interface Considerations 

House Rep Replacement Form: A dedicated form in the admin section is required to initiate the reassignment process, allowing the administrator to: 

Select the previous user and the effective reassignment date (automatically set to the 1st of the month). 

Select the New House Rep (for general reassignment of Accounts/Contacts/Activities). 

Review the list of in-flight Opportunities and apply Option A (New Rep) or Option B (House Account) to each one individually. 

Module-Specific House Rep Display: Consider adding a tab or section within each relevant module (e.g., Accounts, Opportunities, Contacts) to clearly display when a House Rep has been replaced and who the current House Rep for that specific record is. 

Changing the global passthrough rate % for a single vendor’s products from a specified date 

Calculate raw (distributor level) x passthrough rate % (for the agency) =  expected Commission rate %.  Raw commission rates on products from each vendor are negotiated for the distributor, who then takes a cut and passes-through based upon an agreed upon percentage, usually 80% or 90% for a specific vendor to the Agency.  Sometimes, this passthrough rate can be negotiated for an entire book (all vendors) or for specific vendors several years after a baseline is set by the two parties, and while current deals are in flight.  To remedy, we can discuss a way to find these raw numbers on Distribution or Direct commissions reports, multiply by the stated Agency rate %, and calculate the Agency Expected Commission rate %.  For multiple schedules, we need an easier method.  A user can select an existing product, see the revenue schedules related to that product listed below, then select one or more schedules via checkbox, select the new effective date to change the rate %, and then enter the new rate %, then save.  When saved, the system changes the expected commission rate % for said schedule(s) and saved, the result is all product revenue schedules in that opportunity will reflect the new commission rate.  This new calculation allows us to then augment the passthrough rate % with some type of programmatic function, so that after a certain date: 

All existing and billing Revenue schedules will be paid at the new % rate 

and/or All new Revenue schedules sold after a date will be paid at that new rate.   

 

Products Module  

Discuss a future option to change the global passthrough rate % for multiple products from a given vendor.  This is the “raw” rate that vendors pay to Distributors to carry their products and promote them to Agencies like ours.  For example, a raw rate might be 20% for a product, and the “passthrough” rate at 90% for the Agency means that we’ll be paid 18% (20% x .90) on any deal.  When this rate changes, we can change the products themselves in the product catalog for future sales, but we may have the opportunity to get paid a higher amount on all existing sales of that product, so we could adjust these revenue schedules from a certain date forward.  The difficulty here is that this data may not be available.  We could work it out by reversing the calculation, take the passthrough percentage and divide it by our passthrough rate? 
